# Prerelease Desktop: теги v*.*.*-alpha.* / v*.*.*-beta.* / v*.*.*-nightly.* → сборка → GitHub Release (prerelease).
# Stable (v1.0.0) не триггерится — только prerelease. Те же secrets, что и в release.yml.
name: release-prerelease

on:
  push:
    tags:
      - "v*.*.*-*"

permissions:
  contents: write

jobs:
  build-mac:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Set version from tag
        run: |
          export V="${GITHUB_REF_NAME#v}"
          node -e "const p=require('./package.json'); p.version=process.env.V; require('fs').writeFileSync('package.json', JSON.stringify(p,null,2));"

      - run: npm ci

      - name: Detect mac signing / notarization availability
        shell: bash
        run: |
          [[ -n "${{ secrets.MAC_CERTS_P12 }}" && -n "${{ secrets.MAC_CERTS_P12_PASSWORD }}" ]] && echo "HAS_MAC_CERTS=1" >> $GITHUB_ENV || echo "HAS_MAC_CERTS=0" >> $GITHUB_ENV
          [[ -n "${{ secrets.APPLE_ID }}" && -n "${{ secrets.APPLE_TEAM_ID }}" && -n "${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}" ]] && echo "HAS_NOTARIZATION_ENV=1" >> $GITHUB_ENV || echo "HAS_NOTARIZATION_ENV=0" >> $GITHUB_ENV

      - name: Import macOS certs (optional)
        if: env.HAS_MAC_CERTS == '1'
        env:
          MAC_CERTS_P12: ${{ secrets.MAC_CERTS_P12 }}
          MAC_CERTS_P12_PASSWORD: ${{ secrets.MAC_CERTS_P12_PASSWORD }}
        shell: bash
        run: |
          echo "$MAC_CERTS_P12" | base64 --decode > mac-certs.p12
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security import mac-certs.p12 -k build.keychain -P "$MAC_CERTS_P12_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" build.keychain

      - name: Build (mac)
        env:
          DATABASE_URL: postgresql://localhost:5432/ci
          S3_HEALTH_ENABLED: "0"
          GCS_HEALTH_ENABLED: "0"
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          if [[ "$HAS_NOTARIZATION_ENV" == "1" ]]; then
            export APPLE_ID='${{ secrets.APPLE_ID }}'
            export APPLE_TEAM_ID='${{ secrets.APPLE_TEAM_ID }}'
            export APPLE_APP_SPECIFIC_PASSWORD='${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}'
          fi
          npm run electron:build

      - name: Upload artifacts (mac)
        uses: actions/upload-artifact@v4
        with:
          name: dist-mac
          path: dist/*
          if-no-files-found: error

  build-win:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Set version from tag
        run: |
          export V="${GITHUB_REF_NAME#v}"
          node -e "const p=require('./package.json'); p.version=process.env.V; require('fs').writeFileSync('package.json', JSON.stringify(p,null,2));"

      - run: npm ci

      - name: Detect Windows signing availability
        shell: bash
        run: |
          [[ -n "${{ secrets.WIN_CERT_PFX_BASE64 }}" && -n "${{ secrets.WIN_CERT_PFX_PASSWORD }}" ]] && echo "HAS_WIN_CERT=1" >> $GITHUB_ENV || echo "HAS_WIN_CERT=0" >> $GITHUB_ENV

      - name: Prepare Windows signing cert (optional)
        if: env.HAS_WIN_CERT == '1'
        shell: bash
        run: |
          echo "${{ secrets.WIN_CERT_PFX_BASE64 }}" | base64 --decode > win-cert.pfx
          echo "WIN_CERT_PATH=$(pwd)/win-cert.pfx" >> $GITHUB_ENV

      - name: Build (win)
        env:
          DATABASE_URL: postgresql://localhost:5432/ci
          S3_HEALTH_ENABLED: "0"
          GCS_HEALTH_ENABLED: "0"
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          if [[ "$HAS_WIN_CERT" == "1" ]]; then
            export CSC_LINK="$WIN_CERT_PATH"
            export CSC_KEY_PASSWORD='${{ secrets.WIN_CERT_PFX_PASSWORD }}'
          fi
          npm run electron:build

      - name: Upload artifacts (win)
        uses: actions/upload-artifact@v4
        with:
          name: dist-win
          path: dist/*
          if-no-files-found: error

  publish:
    runs-on: ubuntu-latest
    needs: [build-mac, build-win]
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Publish prerelease and upload assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.ref_name }}"
          gh release view "$TAG" >/dev/null 2>&1 || gh release create "$TAG" --prerelease -t "$TAG" -n "Prerelease build. Stable users will not see this update."
          find artifacts -type f -maxdepth 3 -print0 | xargs -0 -I{} gh release upload "$TAG" "{}" --clobber

      - name: Release metrics (size)
        run: |
          echo "## Build sizes"
          du -sh artifacts/dist-mac artifacts/dist-win 2>/dev/null || true
          find artifacts -type f -exec du -b {} \; 2>/dev/null | awk '{s+=$1} END {print "total_bytes:", s+0}'
