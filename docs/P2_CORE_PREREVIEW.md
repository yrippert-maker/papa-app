# P2-Core: Архитектурный pre-review — что нельзя делать

Чеклист «стоп-сигналов» для P2-Core. При появлении любого пункта — остановиться и обсудить.

---

## Инфраструктура

| ❌ Нельзя | Почему |
|-----------|--------|
| Добавлять Redis / Memcached | Вне scope; нет обоснованной потребности |
| Добавлять очереди (Bull, SQS, RabbitMQ) | Вне scope; синхронная модель достаточна |
| Вводить microservices / разбивать монолит | P2-Core — инфра, не архитектура |
| Добавлять Kubernetes/Helm до стабильного v0.2.0 | Преждевременно; Docker достаточно |
| Менять NextAuth на другой auth-провайдер | Вне scope P2-Core |

---

## Доменная логика

| ❌ Нельзя | Почему |
|-----------|--------|
| Менять RBAC, permissions, policy layer | Домен не трогаем |
| Добавлять новые User Stories / фичи | P2-Core — только инфра |
| Менять схему БД (новые таблицы, изменения домена) | Только диалект SQL (SQLite→Postgres) |
| Менять формат ledger_events (event_type, payload) | Hash-chain и аудит — инварианты |
| Добавлять новую бизнес-валидацию | Только миграция существующей |

---

## Миграции

| ❌ Нельзя | Почему |
|-----------|--------|
| Ломать обратную совместимость с SQLite в v0.1.x | CI и dev по умолчанию — SQLite |
| Делать миграцию данных без dry-run и проверки | Риск потери данных |
| Переносить файлы без проверки checksum | Целостность обязательна |
| Пропускать порядок таблиц при SQLite→Postgres (FK) | Нарушение целостности |

---

## Код

| ❌ Нельзя | Почему |
|-----------|--------|
| Дублировать SQL в двух местах (Sqlite/Postgres) без причины | Один источник истины для запросов |
| Хардкодить диалект-специфичный SQL в API routes | Только через adapter |
| Делать долгие транзакции (дольше 1–2 сек) | US-8; SQLITE_BUSY, lock escalation |
| Логировать пароли, токены, секреты | Security |
| Игнорировать `healthCheck()` в adapter | Readiness probe зависит от этого |

---

## Процесс

| ❌ Нельзя | Почему |
|-----------|--------|
| Merge без прохождения PR_ACCEPTANCE | Дисциплина приёмки |
| Релизить v0.2.0 без теста миграции на копии данных | Риск production outage |
| Пропускать обновление env.example и docs | Операторы должны знать новые переменные |

---

## Разрешено

- Абстракция через интерфейсы (DbAdapter, StorageAdapter)
- Два набора миграций (SQLite и Postgres) при необходимости
- Опциональный CI job на Postgres
- Логирование SQLITE_BUSY, connection errors
- Документация по upgrade и backup
