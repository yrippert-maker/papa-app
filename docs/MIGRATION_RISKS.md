# Риски миграции: SQLite → Postgres, Files → S3

## 1. SQLite → PostgreSQL

### Риск: Потеря данных при переносе

| Фактор | Вероятность | Влияние | Митигация |
|--------|-------------|---------|-----------|
| Неверный порядок таблиц (FK) | Средняя | Высокое | Скрипт по фиксированному порядку; dry-run |
| Расхождение типов (INTEGER vs BIGINT) | Низкая | Среднее | Явное приведение в скрипте |
| Экранирование строк, кавычки | Низкая | Среднее | Параметризованные запросы |
| Пустая или частично заполненная Postgres | Средняя | Высокое | Проверка: Postgres пуст или `--force` |
| Прерывание скрипта | Низкая | Высокое | Транзакция; rollback при ошибке |

**Действия:**
- Скрипт в одной транзакции; при любой ошибке — rollback.
- После переноса: проверка `SELECT COUNT(*)` по таблицам; выборочная сверка (например, ledger block_hash).
- Бэкап SQLite перед миграцией.

### Риск: Несовместимость SQL-диалекта

| Фактор | Вероятность | Влияние | Митигация |
|--------|-------------|---------|-----------|
| `AUTOINCREMENT` vs `SERIAL` | Высокая | Низкое | Отдельные миграции или conditional DDL |
| `datetime('now')` vs `now()` | Высокая | Низкое | Замена в Postgres-миграциях |
| `INSERT OR IGNORE` | Средняя | Среднее | `ON CONFLICT DO NOTHING` |
| Безтиповые параметры `?` | Низкая | Среднее | pg использует `$1, $2`; adapter маппит |

**Действия:**
- Миграции для Postgres — отдельные файлы или ветвление в скрипте.
- Unit-тесты на обоих провайдерах для критичных путей.

### Риск: Hash-chain ledger

| Фактор | Вероятность | Влияние | Митигация |
|--------|-------------|---------|-----------|
| Нарушение порядка при переносе | Низкая | Критическое | Сортировка по id; проверка prev_hash/block_hash |
| Точность чисел (float) | Очень низкая | Низкое | payload_json — текст |

**Действия:**
- Переносить `ledger_events` в порядке `id ASC`.
- После переноса: пройти цепочку, проверить `block_hash = hash(prev + payload)`.

---

## 2. Files → S3

### Риск: Потеря или порча файлов

| Фактор | Вероятность | Влияние | Митигация |
|--------|-------------|---------|-----------|
| Прерывание upload | Средняя | Высокое | Retry; проверка checksum после каждого put |
| Неверный key (path) | Средняя | Высокое | key = relative_path; валидация |
| Перезапись существующего | Низкая | Среднее | Проверка перед перезаписью; версионирование S3 |
| Частичный перенос | Средняя | Высокое | Лог перенесённых; идемпотентность (skip если уже есть) |

**Действия:**
- После каждого `put`: GetObject + checksum; при несовпадении — retry или fail.
- Скрипт: вести список перенесённых; при рестарте — продолжать с места остановки.
- Не удалять из FS до явного подтверждения (`--delete-local` только после успешного прогона).

### Риск: Расхождение file_registry и S3

| Фактор | Вероятность | Влияние | Митигация |
|--------|-------------|---------|-----------|
| Файл в registry, но не в S3 | Средняя | Высокое | Скрипт проверяет наличие в S3 после put |
| Файл в S3, но не в registry | Низкая | Среднее | Registry — источник истины; orphan в S3 допустим временно |
| Несовпадение checksum | Низкая | Высокое | Обязательная проверка после переноса |

**Действия:**
- Миграция: для каждой записи в file_registry — read from FS, put to S3, verify checksum.
- Пост-миграция: выборочная сверка (sample) или full scan.

### Риск: Доступ и производительность

| Фактор | Вероятность | Влияние | Митигация |
|--------|-------------|---------|-----------|
| Таймауты при большом объёме | Средняя | Среднее | Batch; throttle; увеличение timeout |
| Credentials / права S3 | Средняя | Высокое | Проверка до миграции; тестовый put/get |
| Сетевая задержка | Низкая | Низкое | Локальный MinIO для теста |

**Действия:**
- Тест на копии (subset файлов) перед полной миграцией.
- Мониторинг времени выполнения; алерт при аномалиях.

---

## 3. Общие рекомендации

1. **Порядок миграции:** Сначала Postgres (данные), потом S3 (файлы). Приложение может работать с Postgres + FS до переноса файлов.
2. **Rollback:** Сохранить SQLite и FS до успешного переключения на v0.2.0.
3. **Окно миграции:** Планировать downtime или read-only режим.
4. **Документация:** Пошаговая инструкция в UPGRADE_V0.2.0.md с учётом этих рисков.
