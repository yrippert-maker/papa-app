# Отчёт технического аудита
## papa-app — Программа автоматизации производственной аналитики

**Дата:** 01.02.2026  
**Объект аудита:** papa-app (Next.js 14, React 18, better-sqlite3)  
**Версия:** 0.1.0

---

## 1. Краткое резюме (Executive Summary)

Система представляет собой local-first веб-приложение для управления ТМЦ (товарно-материальными ценностями), заявками и документацией. Архитектура в целом понятна, база данных спроектирована детально с учётом RBAC и производственных процессов. Однако для production-развёртывания выявлены **критические** и **высокие** риски в области безопасности, отсутствие тестов и CI/CD, а также технический долг в виде хардкода конфигурации и посторонних папок в репозитории.

**Бизнес-интерпретация:** В текущем виде приложение пригодно только для локального использования или закрытых сетей. Развёртывание в публичном доступе без устранения рисков приведёт к утечке данных, несанкционированному доступу и возможному DoS.

---

## 2. Перечень проблем по разделам

### 4.1 Архитектура и структура

| ID | Критичность | Проблема |
|----|-------------|----------|
| A1 | High | **Жёстко прописан путь workspace в config.ts** — `DEFAULT_WORKSPACE = '/Users/yrippertgmail.com/Desktop/papa-app/data'` попадает в сборку и не подходит для других окружений. |
| A2 | Medium | **Синглтон БД в Node.js** — глобальный `db` без явного управления жизненным циклом; при serverless/edge возможны проблемы. |
| A3 | Low | **Посторонние папки в проекте** — «Новая папка», «Новая папка с объектами», `tailwind base.docx` и т.п. засоряют репозиторий. |
| A4 | Low | **next.config.mjs содержит список папок для исключения** — следы от legacy/копий; рекомендуется очистить. |

### 4.2 Качество и поддерживаемость кода

| ID | Критичность | Проблема |
|----|-------------|----------|
| B1 | Medium | **Дублирование разметки STATUS_LABELS и CATEGORY_LABELS** в `incoming/page.tsx` и `outgoing/page.tsx`. |
| B2 | Medium | **Отсутствие общих типов** — интерфейсы TmcRequest, WorkspaceEntry и др. определены локально в страницах, а не в shared types. |
| B3 | Low | **Магические строки** — `'user'` как uploaded_by, `'ADMIN'` в UI; лучше вынести в константы/конфиг. |

### 4.3 Производительность и ресурсоёмкость

| ID | Критичность | Проблема |
|----|-------------|----------|
| C1 | Medium | **Отсутствие пагинации** — `/api/tmc/items`, `/api/tmc/lots`, `/api/tmc/requests` возвращают все записи; при росте данных возможны медленные ответы и лишняя нагрузка. |
| C2 | Low | **Нет кэширования** — API всегда обращается к БД; можно добавить revalidate для стабильных справочников. |

### 4.4 Безопасность

| ID | Критичность | Проблема |
|----|-------------|----------|
| S1 | **Critical** | **Path Traversal в /api/files/list** — параметр `dir` передаётся в `listWorkspace()` без валидации. Запрос `?dir=../../../etc` позволяет читать файлы вне workspace. |
| S2 | **Critical** | **Отсутствие аутентификации и авторизации** — все API и страницы доступны без проверки пользователя. RBAC в БД не используется. |
| S3 | High | **Уязвимости зависимостей** — npm audit выявил 6 уязвимостей (4 high, 2 moderate): Next.js DoS, ESLint stack overflow, glob command injection. |
| S4 | High | **API /api/ledger/append** — принимает произвольный `event_type` и `payload_json` от любого клиента; злоумышленник может подменять события ledger. |
| S5 | Medium | **Загрузка файлов без ограничений** — нет проверки типа, размера, имени; возможны переполнение диска и вредоносные файлы. |
| S6 | Medium | **Логирование ошибок в консоль** — `console.error` может раскрыть внутренние детали в логах. |

### 4.5 Тестирование и CI/CD

| ID | Критичность | Проблема |
|----|-------------|----------|
| T1 | **Critical** | **Отсутствуют автоматические тесты** — нет unit, integration или e2e тестов. |
| T2 | High | **Нет CI/CD** — отсутствует `.github/workflows` или аналог; нет автоматической сборки и проверок. |
| T3 | Medium | **Нет pre-commit hooks** — lint/format не выполняются до коммита. |

### 4.6 Документация и поддержка

| ID | Критичность | Проблема |
|----|-------------|----------|
| D1 | Medium | **Минимальная документация** — README описывает запуск, но нет описания API, архитектуры, миграций БД. |
| D2 | Low | **Схема БД только в коде** — миграции отсутствуют; изменения схемы делаются через `CREATE TABLE IF NOT EXISTS`. |

---

## 3. Классификация по критичности

### Critical
- **S1** — Path Traversal в files/list  
- **S2** — Нет аутентификации/авторизации  
- **T1** — Нет тестов  

### High
- **A1** — Хардкод пути workspace  
- **S3** — Уязвимости npm-зависимостей  
- **S4** — Ledger append без проверки  
- **T2** — Нет CI/CD  

### Medium
- **A2** — Синглтон БД  
- **B1, B2** — Дублирование кода и типов  
- **C1** — Нет пагинации  
- **S5, S6** — Загрузка файлов, логирование  
- **T3** — Нет pre-commit  
- **D1** — Минимальная документация  

### Low
- **A3, A4** — Посторонние папки, конфиг  
- **B3** — Магические строки  
- **C2** — Нет кэширования  
- **D2** — Схема БД  

---

## 4. Описание ключевых проблем

### S1. Path Traversal (Critical)

**В чём проблема:**  
`/api/files/list?dir=../../../etc` передаёт `dir` в `listWorkspace(relativeDir)`. Функция выполняет `join(WORKSPACE_ROOT, relativeDir)` и `readdirSync(absPath)`. После нормализации пути `../../../etc` даёт доступ к файловой системе вне workspace.

**Риски:** Чтение произвольных файлов сервера, утечка конфигурации, секретов.

**Условия:** Любой HTTP-запрос к API.

**Рекомендация:** Нормализовать путь через `path.resolve` и проверять, что результат начинается с `WORKSPACE_ROOT`; отклонять запрос при выходе за границы.

---

### S2. Отсутствие аутентификации (Critical)

**В чём проблема:**  
Нет middleware, защищающего API и страницы. RBAC в БД реализован, но не используется в коде.

**Риски:** Несанкционированный доступ ко всем данным, загрузка/удаление файлов, модификация ledger.

**Условия:** Доступ к приложению по сети.

**Рекомендация:** Внедрить аутентификацию (например, NextAuth.js) и проверку прав перед вызовом API.

---

### S4. Ledger append без проверки (High)

**В чём проблема:**  
`POST /api/ledger/append` принимает `event_type` и `payload_json` и записывает в цепочку без проверки подлинности и консистентности.

**Риски:** Подмена событий, нарушение целостности ledger.

**Рекомендация:** Вызывать append только из доверенного серверного кода; не предоставлять этот endpoint внешним клиентам или защитить его строгой аутентификацией.

---

### T1. Отсутствие тестов (Critical)

**В чём проблема:**  
Нет ни unit-, ни integration-тестов.

**Риски:** Регрессии при изменениях, сложность рефакторинга, низкое качество релизов.

**Рекомендация:** Добавить Jest + React Testing Library, начать с тестов API (files/list, tmc/items) и критичных компонентов.

---

## 5. Рекомендации по устранению

| Проблема | Действие |
|----------|----------|
| S1 | В `listWorkspace` и в API добавить проверку: `path.resolve(absPath).startsWith(path.resolve(WORKSPACE_ROOT))` |
| S2 | Внедрить NextAuth.js (или аналог), защитить API через middleware |
| S3 | Выполнить `npm audit fix`; для breaking changes — планировать обновление Next.js |
| S4 | Ограничить доступ к `/api/ledger/append` или убрать его из публичного API |
| S5 | Ограничить MIME-типы, максимальный размер файла, санитизировать имена |
| A1 | Использовать только `process.env.WORKSPACE_ROOT`, не задавать DEFAULT с путём разработчика |
| T1–T3 | Добавить Jest, CI (GitHub Actions), husky + lint-staged |
| B1–B2 | Вынести shared types и константы в `lib/types.ts`, `lib/constants.ts` |

---

## 6. Оценка трудозатрат (ориентировочно)

| Работа | Часы |
|--------|------|
| Устранение path traversal (S1) | 2–4 |
| Базовая аутентификация (S2) | 16–24 |
| Обновление зависимостей (S3) | 4–8 |
| Защита ledger, ограничения загрузки (S4, S5) | 4–8 |
| Базовый набор тестов (T1) | 16–24 |
| CI/CD (T2) | 4–8 |
| Рефакторинг config, типов, констант (A1, B1–B2) | 8–12 |
| Пагинация API (C1) | 8–12 |
| **Итого (минимальный набор)** | **62–100** |

---

## 7. Что не является проблемой

- **SQL-инъекции** — используется prepared statements (better-sqlite3), параметры передаются корректно.  
- **XSS** — React экранирует вывод по умолчанию; явно опасных `dangerouslySetInnerHTML` не обнаружено.  
- **CSRF** — для API используются JSON/formData; при добавлении auth потребуется учёт CSRF.  
- **Архитектура БД** — схема продуманная, с индексами, FK и доменными ограничениями.  
- **Качество разметки** — Tailwind, компоненты, стили выглядят консистентно.

---

## 8. Roadmap внедрения рекомендаций

### Фаза 1 (критично, 1–2 недели)
1. Закрыть path traversal (S1).  
2. Ограничить или убрать публичный доступ к `/api/ledger/append` (S4).  
3. Добавить ограничения на загрузку файлов (S5).  

### Фаза 2 (безопасность, 2–3 недели)
4. Внедрить аутентификацию и базовую авторизацию (S2).  
5. Обновить зависимости и устранить уязвимости npm (S3).  

### Фаза 3 (качество, 2–3 недели)
6. Добавить базовые тесты для API (T1).  
7. Настроить CI (сборка, lint, тесты) (T2).  

### Фаза 4 (поддерживаемость)
8. Рефакторинг config, типов, констант (A1, B1–B2).  
9. Пагинация в API (C1).  
10. Расширение документации (D1).  

---

---

## 9. Статус внедрения (01.02.2026)

### Выполнено (P0–P2)

| Пункт | Статус |
|-------|--------|
| **S1 Path Traversal** | ✅ `lib/workspace.ts`: `resolveWorkspacePath()`, `isPathInsideWorkspace()`; reject в API при `..` |
| **S2 Аутентификация** | ✅ NextAuth Credentials, middleware, страница /login, кнопка «Выйти» |
| **S4 Ledger validation** | ✅ zod-схема, allowlist `FILE_REGISTERED`, валидация payload |
| **S5 Ограничения загрузки** | ✅ max 50 MB, allowlist расширений |
| **A1 Workspace** | ✅ `process.cwd()/data` вместо хардкода; `WORKSPACE_IS_EXPLICIT` для мониторинга |
| **T1 Тесты** | ✅ Jest, 9 unit-тестов (workspace, ledger-schema) |
| **T2 CI** | ✅ `.github/workflows/ci.yml` — lint, test, build |

### Отложено

| Пункт | Причина |
|-------|---------|
| **S3 npm audit** | `npm audit fix --force` влечёт breaking changes (Next.js 16); требуется отдельный апгрейд |
| **P1-4** | Оставлено на фазу обновления зависимостей |

### npm audit — план (техдолг)

- **Статус:** Уязвимости (6 шт.) устраняются при переходе на **Next.js ≥16**.
- **Сейчас:** `npm audit fix --force` не рекомендуется — breaking changes без апгрейда.
- **Roadmap:** [ ] Миграция на Next.js 16+ при следующем цикле обновления.

### Security hygiene (01.02.2026)

- **Предупреждение default credentials:** баннер на дашборде при `!AUTH_USER`
- **Логирование:** `[files/list] Path traversal blocked`, `[ledger/append] Rejected`

### Новые файлы

- `lib/ledger-schema.ts` — валидация ledger
- `types/next-auth.d.ts` — расширение типов NextAuth
- `app/api/auth/[...nextauth]/route.ts`
- `app/login/page.tsx`
- `middleware.ts`
- `components/providers/SessionProvider.tsx`
- `env.example`
- `__tests__/lib/workspace.test.ts`, `__tests__/lib/ledger-schema.test.ts`
- `.github/workflows/ci.yml`

### Первый запуск

```bash
cp env.example .env.local
# Задать NEXTAUTH_SECRET (openssl rand -base64 32)
# Опционально: AUTH_USER, AUTH_PASSWORD, WORKSPACE_ROOT
npm run dev
# Логин: admin / admin (если не заданы AUTH_USER/AUTH_PASSWORD)
```

---

*Отчёт подготовлен в соответствии с техническим заданием на проведение полного аудита программного обеспечения.*
