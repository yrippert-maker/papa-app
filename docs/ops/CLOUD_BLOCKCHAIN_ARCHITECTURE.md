# Cloud + Blockchain: архитектура и план внедрения

Практическая схема переноса в облако с блокчейн-якорением:
- **основная работа** — в облаке
- **Mac** — актуальная резервная копия
- **блокчейн** — фиксация целостности (хэши, не данные)
- **аудит- и комплаенс-допустимость** без лишних рисков

---

## Целевая модель

```
┌──────────────┐
│   Cloud      │  ← основная работа
│  (Docs + AI) │
└──────┬───────┘
       │ hash / event
       ▼
┌──────────────┐
│  Blockchain  │  ← immutable proof
│ (hash only)  │
└──────┬───────┘
       │ sync (read-only / mirror)
       ▼
┌──────────────┐
│   Your Mac   │  ← резерв + независимая копия
│ (offline OK) │
└──────────────┘
```

**Single source of truth** → облако  
**Trusted mirror** → Mac  
**Proof of integrity** → блокчейн (хэши, не данные)

---

## 1. Принципиальные решения

### 1.1 Что НЕ кладём в блокчейн

- ❌ документы
- ❌ тексты
- ❌ персональные данные
- ❌ внутренние логи

➡️ В блокчейне **только хэши и метаданные**.

Критично для: GDPR, авиационного комплаенса, стоимости, юридической применимости.

### 1.2 Источник истины

| Компонент | Роль |
|-----------|------|
| Cloud repository | Источник истины |
| Mac | Криптографически проверяемая реплика |
| Blockchain | Независимое доказательство неподменяемости |

---

## 2. Архитектура хранения

### 2.1 Облако (основное рабочее пространство)

- Git-подобное хранилище (Git + LFS, Object Storage с versioning, Secure Document Vault)
- Версионирование каждого документа
- Immutable snapshots (WORM-подобная модель)

**Требования:**

- `version_id`
- `sha256` каждого файла
- audit log (кто / когда / что)

### 2.2 Mac (резерв)

- read-only mirror (sync из облака)
- автоматический pull из облака
- локальный ledger (read-only)
- возможность доказать: версия на Mac = версии в облаке на дату X
- **не используется как write-source** даже при аварии облака — только верификация, анализ и восстановление

---

## 3. Блокчейн

### 3.1 Назначение

- Доказательство **неподменяемости**
- Защита от: админов облака, форс-мажора, споров «кто и когда изменил»

### 3.2 Что якорим

Для каждого значимого события:

```json
{
  "document_id": "...",
  "version": "...",
  "sha256": "...",
  "author": "...",
  "timestamp": "...",
  "action": "create|update|approve|export"
}
```

В блокчейн уходит: `hash(этого объекта)`.

### 3.3 Выбор блокчейна

**НЕ рекомендовано:**

- публичные L1 с высокими комиссиями
- Web3-платформы без long-term SLA

**Рекомендовано:**

- Private / consortium chain
- либо periodic anchoring в публичную сеть (Merkle root)

---

## 4. Поток работы

### 4.1 Редактирование

1. Документ правится в облаке
2. Создаётся новая версия
3. Считается sha256
4. Записывается событие в audit-ledger
5. Хэш якорится в блокчейн

### 4.2 Синхронизация на Mac

- Mac регулярно: pull, проверка sha256, сверка с blockchain-якорем
- При расхождении → **alarm**

---

## 5. Контроль безопасности

### 5.1 Роли

| Роль | Права |
|------|-------|
| Author | Редактирование |
| Reviewer | Комментирование |
| Approver | Фиксация версии |
| System | Якорение в блокчейн |

### 5.2 Ключи

- Отдельные ключи для cloud и blockchain
- Ключи не хранятся в коде
- На Mac — read-only ключи

---

## 6. План внедрения

| Этап | Срок | Содержание |
|------|------|------------|
| 1. Подготовка | 1–2 нед | Cloud-репозиторий, versioning, audit, sha256 pipeline |
| 2. Blockchain anchoring | 1 нед | Ledger-event → hash, anchoring (dummy chain для начала) |
| 3. Mac mirror | неск. дней | Secure sync, проверка целостности, read-only verification |
| 4. Документирование | — | Security Architecture Appendix, Data flow, Threat model |

---

## 7. Следующие решения (TODO)

Перед стартом нужно выбрать:

1. **Тип облака:** public / private / hybrid  
   - Варианты: AWS, GCP, self-hosted, другое

2. **Модель блокчейна:** private chain vs periodic anchoring в публичную сеть

3. **Уровень автоматизации:** что нужно сразу, что можно отложить

4. **Реальный блокчейн сразу** или допустим staging-контур (dummy/mock)

### Чек-лист решений

| Вопрос | Ответ |
|--------|-------|
| Какое облако рассматривается? | _AWS / GCP / self-hosted / другое_ |
| Реальный блокчейн сразу или staging? | _реальный / staging (dummy)_ |
| Private chain или anchoring в публичную? | _private / anchoring_ |

---

## 8. Рекомендации (исходя из архитектуры papa-app)

С учётом: compliance/audit-платформа, ledger + anchoring, ECS/RDS, безперебойности и защиты.

### 8.1 Облако

| Критерий | Рекомендация | Обоснование |
|----------|--------------|-------------|
| **Провайдер** | **AWS** (уже ECS Fargate, RDS) | Единый стек, меньше интеграций, S3 versioning, KMS, IAM. |
| **Модель** | **Hybrid** (prod в AWS, Mac — mirror) | Соответствует целевой архитектуре Cloud → Mac. |
| **Хранилище** | S3 + versioning + Object Lock (WORM) | Immutable snapshots, audit trail, совместимо с ledger. |

**Безперебойность:** ECS desired count ≥2, multi-AZ RDS, ALB health checks. Уже заложено в ECS_FARGATE_DEPLOY.

### 8.2 Блокчейн

| Критерий | Рекомендация | Обоснование |
|----------|--------------|-------------|
| **Модель** | **Periodic anchoring в публичную сеть** | Уже реализовано: Merkle root → Polygon. Не нужен отдельный private chain. |
| **Сеть** | **Polygon** (prod) / Polygon Amoy (dev) | Низкие комиссии, стабильность, offline-верификация по receipt. |
| **Частота** | **Ежедневно** (period 00:00–23:59 UTC) | Баланс: доказательство целостности без избыточных транзакций. |

**Безопасность:** В блокчейн уходят только Merkle root и метаданные. Данные и ПД — в облаке.

### 8.3 Staging vs реальный блокчейн

| Фаза | Рекомендация |
|------|--------------|
| **Сейчас** | Реальный Polygon (prod) — anchoring уже настроен (ANCHORING_POLYGON). |
| **Новый контур** | Staging: Polygon Amoy (testnet) для отладки, затем prod. |

Не нужен dummy-chain: Amoy даёт полный цикл с минимальными рисками.

### 8.4 Mac mirror

| Критерий | Рекомендация |
|----------|--------------|
| **Sync** | `git pull` + `rsync`/rclone из S3 (read-only на Mac). |
| **Проверка** | Локальный скрипт: sha256 артефактов, сверка с ledger + anchor receipt. |
| **Ключи** | На Mac — только read-only (verify). Publish/confirm — только в облаке. |

### 8.5 Защита и комплаенс

| Аспект | Реализация |
|--------|------------|
| **Целостность** | Ledger (append-only) + Merkle + Polygon anchor. |
| **Конфиденциальность** | S3 encryption (SSE-S3/SSE-KMS), RDS encryption, секреты в Secrets Manager. |
| **Аудит** | `ledger_events`, S3 access logs, CloudTrail. |
| **Роли** | RBAC (Author/Reviewer/Approver) — уже в системе. |

### 8.6 Итоговая схема

```
AWS (ECS + RDS + S3)     ← source of truth, основная работа
        │
        │ Merkle root / period
        ▼
Polygon (chain_id 137)   ← immutable proof (уже в prod)
        │
        │ sync + verify (read-only)
        ▼
Mac                      ← резерв, offline-верификация
```

**Рекомендуемый порядок:** оставить текущий anchoring на Polygon; добавить Mac mirror (sync + verify); при необходимости — S3 Object Lock для WORM.

---

## 9. Multi-Cloud Failover (optional)

Система поддерживает **Active / Passive multi-cloud** модель. Второе облако развёртывается как warm-standby и автоматически принимает нагрузку при недоступности основного, при условии соблюдения требований целостности данных. Историческая целостность обеспечивается независимым blockchain-якорением и проверяемым Mac-mirror.

### 9.1 Схема

```
              ┌─────────────────────┐
              │  Cloud A (Primary)  │
              │  Docs + AI + Audit  │
              └─────────┬───────────┘
                        │ hash / ledger
                        ▼
                  Blockchain (hash only)
                        ▲
                        │
              ┌─────────┴───────────┐
              │  Cloud B (Standby)  │
              │  Docs + AI (warm)   │
              └─────────┬───────────┘
                        │ sync / verify
                        ▼
                     Your Mac (trusted mirror)
```

**Принцип:** облака A и B **не доверяют друг другу**; оба проверяются через blockchain + хэши; Mac остаётся независимой точкой контроля.

### 9.2 Что переключается автоматически

| Компонент | Автоматически |
|-----------|---------------|
| Пользовательский трафик | ✅ DNS / health checks |
| API / UI | ✅ |
| AI-обработка | ✅ |
| Работа с документами | ✅ (если данные синхронизированы) |

**Не «магически»:** если второе облако не прогрето или данные отстают больше допустимого RPO — failover не выполняется.

### 9.3 Что нужно добавить

| Компонент | Требование |
|-----------|------------|
| **Cloud B (Standby)** | Те же контейнеры/ECS, доступ к реплике S3, тот же код. IaC (Terraform) — один и тот же, два провайдера. |
| **Репликация данных** | S3 → S3 replication (cross-cloud или sync); versioning; ledger append-only репликация. |
| **БД** | Standby read-replica + log shipping; позже — managed cross-cloud replication. |
| **Failover** | DNS failover (Route53 и т.п.), health checks Cloud A. Safety-gate: если данные в B отстают > N минут — не переключать. |

### 9.4 Границы возможностей

| Вопрос | Ответ |
|--------|-------|
| Можно ли «перенести всё за секунду в пустое облако»? | ❌ Нет |
| Можно ли автоматически переключиться на готовое второе облако? | ✅ Да |
| Можно ли доказать целостность после переключения? | ✅ Да |
| Есть ли vendor lock-in? | ❌ Нет |

### 9.5 Комплаенс

- Нет split-brain
- Нет двойной записи без якорения
- Blockchain фиксирует порядок версий
- Mac позволяет доказать, что ни одно облако «не переписало историю»

Приемлемо для: авиационного регулятора, аудита, суда, службы ИБ.

### 9.6 Рекомендация: второе облако

| Вариант | Рекомендация | RTO | RPO | Сложность | Обоснование |
|---------|--------------|-----|-----|-----------|-------------|
| **AWS второй регион** | ✅ **Первый шаг** | 5–15 мин | &lt;5 мин | Низкая | Тот же стек, S3 CRR, RDS cross-region replica, Route53 failover. Минимум новых интеграций. |
| **GCP** | Опционально позже | 15–60 мин | &lt;15 мин | Средняя | Истинный multi-vendor, но нужна адаптация (Cloud Run/GKE, Cloud SQL, GCS). |

**Рекомендуемая схема:** AWS Primary (напр. eu-central-1) + AWS Standby (другой регион, напр. eu-west-1).

- **S3:** Cross-Region Replication (CRR) — нативная репликация
- **RDS:** Cross-Region Read Replica → promote при failover
- **ECS:** тот же Terraform, другой region
- **DNS:** Route53 health check на Primary ALB → при failure переключение на Standby
- **Блокчейн:** Polygon общий, без изменений

**RTO:** ~10 мин (promote RDS + DNS propagation). **RPO:** &lt;5 мин (асинхронная репликация).

**RTO/RPO Policy:** RTO и RPO являются настраиваемыми параметрами политики отказоустойчивости. Автоматический failover разрешён только при соблюдении заданных порогов целостности данных (RPO) и доступности сервисов (RTO).

В случае пограничных состояний (частичная деградация, сомнительная репликация) переключение может требовать ручного подтверждения уполномоченной роли (Approver / SRE).

### 9.7 Mac-mirror: границы использования

Mac-mirror **не используется как write-source** даже при аварии облака и служит исключительно для верификации, анализа и восстановления. Это исключает split-brain и сохраняет единый источник истины.

### 9.8 Следующие шаги (по запросу)

- [DR-runbook](../runbooks/DR_FAILOVER.md) (кто/что/когда) — **готов**
- [Terraform multi-region](../../terraform/multi-region/) (S3 CRR) — **готов**
- [ADR-001](../architecture/ADR-001-cloud-blockchain-architecture.md) — Architecture Decision Record

---

## 10. Обоснование модели

- ✔️ Облако = удобство и масштабируемость
- ✔️ Mac = суверенная резервная копия
- ✔️ Блокчейн = независимое доказательство
- ✔️ Нет vendor lock-in
- ✔️ Нет регуляторных красных флагов
- ✔️ Multi-cloud failover — без изменения концепции

Enterprise-grade подход, приемлемый для: ИБ, аудита, регулятора, инвестора.
